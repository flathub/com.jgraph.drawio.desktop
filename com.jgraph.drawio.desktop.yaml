app-id: com.jgraph.drawio.desktop
branch: stable
runtime: org.freedesktop.Platform
runtime-version: '19.08'
sdk: org.freedesktop.Sdk
base: org.electronjs.Electron2.BaseApp
base-version: '19.08'
sdk-extensions:
  - org.freedesktop.Sdk.Extension.node12
separate-locales: false
command: start-drawio
finish-args:
  - '--share=ipc'
  - '--socket=x11'
  - '--share=network'
  - '--filesystem=home'
modules:
  - name: yarn
    buildsystem: simple
    build-commands:
      - 'cp -a * /app'
    cleanup:
      - '*'
    sources:
      - type: archive
        url: https://github.com/yarnpkg/yarn/releases/download/v1.22.4/yarn-v1.22.4.tar.gz
        sha256: bc5316aa110b2f564a71a3d6e235be55b98714660870c5b6b2d2d3f12587fb58

  - name: drawio
    buildsystem: simple
    build-options:
      append-path: '/usr/lib/sdk/node12/bin:/app/yarn/bin'
      env:
        ELECTRON_CACHE: '/run/build/drawio/flatpak-node/electron-cache'
        npm_config_nodedir: '/usr/lib/sdk/node12'
    build-commands:
      - 'HOME=$PWD yarn config --offline set yarn-offline-mirror $FLATPAK_BUILDER_BUILDDIR/flatpak-node/yarn-mirror'
      - 'yarn --offline'
      - 'yarn run --offline release-linux --dir'
      - 'cp -r dist/linux*-unpacked $FLATPAK_DEST/drawio'
      - 'install -D -m 644 build/icon.svg $FLATPAK_DEST/share/icons/hicolor/scalable/apps/$FLATPAK_ID.svg'
      - 'icon_in=build/icon.svg;
        icon_out=$FLATPAK_ID.png;
        for size in {16,32,48,64,96,128,256,512}; do
        rsvg-convert $icon_in -w $size -h $size -a -f png -o $icon_out;
        install -D -m 644 -t $FLATPAK_DEST/share/icons/hicolor/${size}x${size}/apps $icon_out;
        done;'
      - 'install -D -m 755 start-drawio.sh $FLATPAK_DEST/bin/start-drawio'
      - 'install -D -m 644 -t $FLATPAK_DEST/share/metainfo $FLATPAK_ID.metainfo.xml'
      - 'install -D -m 644 -t $FLATPAK_DEST/share/applications $FLATPAK_ID.desktop'
    sources:
      - type: git
        url: https://github.com/jgraph/drawio-desktop
        tag: v13.0.3
        commit: 94ef0314c229899565eb50b618a5c249f24f56e2
      - generated-sources.json
      - type: script
        dest-filename: start-drawio.sh
        commands:
          - export TMPDIR="$XDG_RUNTIME_DIR/app/$FLATPAK_ID"
          - exec zypak-wrapper /app/drawio/drawio "$@"
      - type: file
        path: com.jgraph.drawio.desktop.metainfo.xml
      - type: file
        path: com.jgraph.drawio.desktop.desktop
